<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/inter.css" />
    <script src="/js/jquery.min.js"></script>
    <link rel="icon" href="images/favicon3.gif">
    <link rel="shortcut icon" href="images/favicon3.gif">
    <style>
        :root {
            --primary-color: #1a5276;
            --secondary-color: #2874a6;
            --accent-color: #3498db;
            --text-color: #333;
            --light-text: #f8f9fa;
            --border-color: #d6dbdf;
            --background-color: #f5f5f5;
            --card-bg: #ffffff;
            --header-bg: #1a5276;
            --footer-bg: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .blurry-navbar {
            background-color: var(--header-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-content h1 {
            color: white;
            margin: 0;
            font-weight: 600;
        }

        .navbar-content nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .navbar-content nav ul li {
            margin-left: 1.5rem;
        }

        .navbar-content nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 0;
            position: relative;
            transition: color 0.3s;
        }

        .navbar-content nav ul li a:hover {
            color: #f0f0f0;
        }

        .navbar-content nav ul li a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 0;
            background-color: white;
            transition: width 0.3s;
        }

        .navbar-content nav ul li a:hover::after {
            width: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .tab-bar {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .tab-bar button {
            flex: 1;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 500;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-bar button.active {
            background-color: var(--accent-color);
            color: white;
            border-bottom-color: var(--primary-color);
        }

        .tab-bar button:hover:not(.active) {
            background-color: rgba(52, 152, 219, 0.1);
            border-bottom-color: var(--accent-color);
        }

        .table-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-input {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            width: 200px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .db-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .db-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .db-card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .db-card-body {
            padding: 0;
        }

        .db-card-field {
            display: flex;
            flex-direction: row;
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px solid var(--border-color);
        }

        .db-card-field:last-child {
            border-bottom: none;
        }

        .db-card-label {
            background-color: rgba(26, 82, 118, 0.1);
            color: var(--primary-color);
            font-weight: 500;
            padding: 0.75rem 1rem;
            min-width: 120px;
            width: 30%;
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            box-sizing: border-box;
        }

        .db-card-value {
            padding: 0.75rem 1rem;
            flex: 1;
            background-color: white;
            color: var(--text-color);
            width: 100%;
            box-sizing: border-box;
        }

        .db-card-value.multiline {
            white-space: pre-line;
            max-height: 80px;
            overflow-y: auto;
        }

        .db-card-footer {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .db-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid var(--border-color);
        }

        #herb-cards,
        #plant-cards,
        #prescription-cards,
        #literature-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .navbar-content {
                flex-direction: column;
                padding: 1rem;
            }

            .navbar-content nav {
                margin-top: 1rem;
            }

            .navbar-content nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }

            .navbar-content nav ul li {
                margin: 0.5rem;
            }

            .tab-bar {
                flex-direction: column;
            }

            .tab-bar button {
                width: 100%;
                border-bottom: none;
                border-left: 3px solid transparent;
            }

            .tab-bar button.active {
                border-left-color: var(--primary-color);
            }

            .action-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .search-container {
                width: 100%;
                flex-direction: column;
            }

            .search-input {
                width: 100%;
            }

            #herb-cards,
            #plant-cards,
            #prescription-cards,
            #literature-cards {
                grid-template-columns: 1fr;
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <header class="blurry-navbar">
        <div class="navbar-content">
            <h1 class="text-3xl font-bold">藏药植物药知识平台</h1>
            <nav>
                <ul>
                    <li><a href="recognize_v.html">图片识别</a></li>
                    <li><a href="graph_v.html">慧灵智能体</a></li>
                    <li><a href="db_v.html">数据库</a></li>
                    <li><a href="admin_login_v.html">管理中心</a></li>
                    <li><a href="me_v.html">个人中心</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container mx-auto px-4">
        <!-- Tab 栏 -->
        <div class="tab-bar mb-6">
            <button id="herb-tab" class="active" onclick="switchTab('herb')">药材信息表</button>
            <button id="plant-tab" onclick="switchTab('plant')">植物信息表</button>
            <button id="prescription-tab" onclick="switchTab('prescription')">药方信息表</button>
            <button id="literature-tab" onclick="switchTab('literature')">文献信息表</button>
        </div>

        <!-- 数据内容区域 -->
        <div id="content" class="w-full">
            <!-- 药材信息表 -->
            <div id="herb" class="table w-full">
                <div class="action-bar">
                    <div class="table-title mb-0">药材信息表</div>
                    <div class="search-container">
                        <input type="text" id="herb-search" class="search-input" placeholder="请输入药材名称">
                        <button class="btn btn-primary" onclick="searchTabData('herb')">搜索</button>
                    </div>
                </div>
                <div id="herb-cards" class="grid grid-cols-1 gap-4"></div>
            </div>

            <!-- 植物信息表 -->
            <div id="plant" class="table hidden w-full">
                <div class="action-bar">
                    <div class="table-title mb-0">植物信息表</div>
                    <div class="search-container">
                        <input type="text" id="plant-search" class="search-input" placeholder="请输入植物名称">
                        <button class="btn btn-primary" onclick="searchTabData('plant')">搜索</button>
                    </div>
                </div>
                <div id="plant-cards" class="grid grid-cols-1 gap-4"></div>
            </div>

            <!-- 药方信息表 -->
            <div id="prescription" class="table hidden w-full">
                <div class="action-bar">
                    <div class="table-title mb-0">药方信息表</div>
                    <div class="search-container">
                        <input type="text" id="prescription-search" class="search-input" placeholder="请输入药方名称">
                        <button class="btn btn-primary" onclick="searchTabData('prescription')">搜索</button>
                    </div>
                </div>
                <div id="prescription-cards" class="grid grid-cols-1 gap-4"></div>
            </div>

            <!-- 文献信息表 -->
            <div id="literature" class="table hidden w-full">
                <div class="action-bar">
                    <div class="table-title mb-0">文献信息表</div>
                    <div class="search-container">
                        <input type="text" id="literature-search" class="search-input" placeholder="请输入文献标题">
                        <button class="btn btn-primary" onclick="searchTabData('literature')">搜索</button>
                    </div>
                </div>
                <div id="literature-cards" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>
    </div>

    <!-- 查看详情模态框 -->
    <div id="detail-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="detail-modal-title">详细信息</h3>
                <button class="modal-close" onclick="closeModal('detail-modal')">×</button>
            </div>
            <div class="modal-body" id="detail-modal-body">
                <!-- 详情内容将在这里动态生成 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('detail-modal')">关闭</button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'herb';
        let currentSearchKeywords = {
            herb: '',
            plant: '',
            prescription: '',
            literature: ''
        };

        // 切换 Tab 并更新按钮样式
        function switchTab(tabName) {
            currentTab = tabName;
            currentSearchKeywords[tabName] = ''; // 清空搜索关键词
            document.getElementById(`${tabName}-search`).value = ''; // 清空搜索框

            document.querySelectorAll('.table').forEach(table => table.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');

            document.querySelectorAll('.tab-bar button').forEach(button => button.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            loadTabData(tabName);
        }

        // 加载对应 Tab 的数据
        function loadTabData(tabName) {
            const keyword = currentSearchKeywords[tabName];
            console.log(`loadTabData: tab=${tabName}, keyword=${keyword}`);
            if (keyword) {
                searchTabData(tabName, keyword);
            } else {
                if (tabName === 'herb') {
                    loadHerbData();
                } else if (tabName === 'plant') {
                    loadPlantData();
                } else if (tabName === 'prescription') {
                    loadPrescriptionData();
                } else if (tabName === 'literature') {
                    loadLiteratureData();
                }
            }
        }

        // 搜索 Tab 数据
        function searchTabData(tabName) {
            const inputElement = document.getElementById(`${tabName}-search`);
            console.log(`searchTabData: tab=${tabName}, inputElement=`, inputElement);
            const keyword = inputElement ? inputElement.value.trim() : '';
            console.log(`searchTabData: raw input value=${keyword}`);

            currentSearchKeywords[tabName] = keyword;
            console.log(`searchTabData: currentSearchKeywords[${tabName}]=${currentSearchKeywords[tabName]}`);

            const cardsContainer = `#${tabName}-cards`;

            // Show error only if user clicks search with empty input
            if (!keyword) {
                console.log('Empty search input');
                $(cardsContainer).html('<div class="text-center p-4 text-danger">请输入有效的名称</div>');
                return;
            }

            $(cardsContainer).html('<div class="loader mx-auto"></div>');

            // Map tabName to backend endpoint
            const endpointMap = {
                herb: 'searchHerb',
                plant: 'searchPlant',
                prescription: 'searchPrescription',
                literature: 'searchLiterature'
            };

            // Search directly by name
            const url = `/db/${endpointMap[tabName]}?name=${encodeURIComponent(keyword)}`;
            console.log(`AJAX request: ${url}`);
            $.ajax({
                type: 'get',
                url: `/db/${endpointMap[tabName]}`,
                data: { name: keyword },
                success: function (data) {
                    console.log(`Search success: data=`, data);
                    let html = '';
                    // Wrap single record in array for card generation
                    const dataArray = data ? [data] : [];
                    console.log(`dataArray length: ${dataArray.length}`);

                    if (tabName === 'herb') {
                        html = generateHerbCards(dataArray);
                    } else if (tabName === 'plant') {
                        html = generatePlantCards(dataArray);
                    } else if (tabName === 'prescription') {
                        html = generatePrescriptionCards(dataArray);
                    } else if (tabName === 'literature') {
                        html = generateLiteratureCards(dataArray);
                    }

                    if (dataArray.length === 0) {
                        html = '<div class="text-center p-4">未找到匹配的记录</div>';
                    }

                    $(cardsContainer).html(html);
                },
                error: function (xhr, status, error) {
                    console.error(`搜索${tabName}数据失败: status=${status}, error=${error}, response=`, xhr.responseText);
                    $(cardsContainer).html('<div class="text-center p-4 text-danger">搜索失败，请稍后再试</div>');
                }
            });
        }

        // 加载药材信息数据
        function loadHerbData() {
            $("#herb-cards").html('<div class="loader mx-auto"></div>');
            $.ajax({
                type: 'get',
                url: `/db/herbAll`,
                success: function (response) {
                    console.log(`loadHerbData success: records=${response.length}`);
                    const herbs = response;
                    const html = generateHerbCards(herbs);
                    $("#herb-cards").html(html || '<div class="text-center p-4">暂无药材数据</div>');
                },
                error: function (xhr, status, error) {
                    console.error("获取药材数据失败:", error);
                    $("#herb-cards").html('<div class="text-center p-4 text-danger">获取数据失败，请稍后再试</div>');
                }
            });
        }

        // 生成药材卡片
        function generateHerbCards(herbs) {
            let html = '';
            for (const herb of herbs) {
                html += `
                    <div class="db-card">
                        <div class="db-card-header">
                            ${escapeHtml(herb.herbName)}
                        </div>
                        <div class="db-card-body">
                            <div class="db-card-field">
                                <div class="db-card-label">ID</div>
                                <div class="db-card-value">${herb.herbId}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">关联植物ID</div>
                                <div class="db-card-value">${herb.plantId || '无'}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">藏文名</div>
                                <div class="db-card-value">${escapeHtml(herb.herbTibetanName)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">别名</div>
                                <div class="db-card-value">${escapeHtml(herb.herbAlias)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">描述</div>
                                <div class="db-card-value multiline">${escapeHtml(herb.herbDescription)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">药用部位</div>
                                <div class="db-card-value">${escapeHtml(herb.partUsed)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">特征</div>
                                <div class="db-card-value multiline">${escapeHtml(herb.herbFeatures)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">性味归经</div>
                                <div class="db-card-value multiline">${escapeHtml(herb.flavorTropism)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">功能与主治</div>
                                <div class="db-card-value multiline">${escapeHtml(herb.functionIndication)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">临床应用</div>
                                <div class="db-card-value multiline">${escapeHtml(herb.clinicalApplication)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">药理作用</div>
                                <div class="db-card-value multiline">${escapeHtml(herb.pharmacologicalEffect)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">附注</div>
                                <div class="db-card-value multiline">${escapeHtml(herb.notes)}</div>
                            </div>
                        </div>
                        <div class="db-card-footer">
                            <button class="btn btn-primary" onclick="viewHerbDetail('${herb.herbId}')">查看详情</button>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // 加载植物信息数据
        function loadPlantData() {
            $("#plant-cards").html('<div class="loader mx-auto"></div>');
            $.ajax({
                type: 'get',
                url: `/db/plantAll`,
                success: function (response) {
                    console.log(`loadPlantData success: records=${response.length}`);
                    const plants = response;
                    const html = generatePlantCards(plants);
                    $("#plant-cards").html(html || '<div class="text-center p-4">暂无植物数据</div>');
                },
                error: function (xhr, status, error) {
                    console.error("获取植物数据失败:", error);
                    $("#herb-cards").html('<div class="text-center p-4 text-danger">获取数据失败，请稍后再试</div>');
                }
            });
        }

        // 生成植物卡片
        function generatePlantCards(plants) {
            let html = '';
            for (const plant of plants) {
                html += `
                    <div class="db-card">
                        ${plant.imgPath ? `<img src="${escapeHtml(plant.imgPath)}" alt="${escapeHtml(plant.plantName)}" class="db-card-image">` : ''}
                        <div class="db-card-header">
                            ${escapeHtml(plant.plantName)}
                        </div>
                        <div class="db-card-body">
                            <div class="db-card-field">
                                <div class="db-card-label">ID</div>
                                <div class="db-card-value">${plant.plantId}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">拉丁学名</div>
                                <div class="db-card-value">${escapeHtml(plant.plantLatin)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">别称</div>
                                <div class="db-card-value">${escapeHtml(plant.plantAlias)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">藏文名</div>
                                <div class="db-card-value">${escapeHtml(plant.plantTibetanName)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">科名</div>
                                <div class="db-card-value">${escapeHtml(plant.plantFamilyName)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">属名</div>
                                <div class="db-card-value">${escapeHtml(plant.plantGenusName)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">特征</div>
                                <div class="db-card-value multiline">${escapeHtml(plant.plantFeatures)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">采集地点</div>
                                <div class="db-card-value">${escapeHtml(plant.plantOrigin)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">保护等级</div>
                                <div class="db-card-value">${escapeHtml(plant.plantProtectLevel)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">附注</div>
                                <div class="db-card-value multiline">${escapeHtml(plant.notes)}</div>
                            </div>
                        </div>
                        <div class="db-card-footer">
                            <button class="btn btn-primary" onclick="viewPlantDetail('${plant.plantId}')">查看详情</button>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // 加载药方信息数据
        function loadPrescriptionData() {
            $("#prescription-cards").html('<div class="loader mx-auto"></div>');
            $.ajax({
                type: 'get',
                url: `/db/prescriptionAll`,
                success: function (response) {
                    console.log(`loadPrescriptionData success: records=${response.length}`);
                    const prescriptions = response;
                    const html = generatePrescriptionCards(prescriptions);
                    $("#prescription-cards").html(html || '<div class="text-center p-4">暂无药方数据</div>');
                },
                error: function (xhr, status, error) {
                    console.error("获取药方数据失败:", error);
                    $("#prescription-cards").html('<div class="text-center p-4 text-danger">获取数据失败，请稍后再试</div>');
                }
            });
        }

        // 生成药方卡片
        function generatePrescriptionCards(prescriptions) {
            let html = '';
            for (const prescription of prescriptions) {
                html += `
                    <div class="db-card">
                        ${prescription.imageUrl ? `<img src="${escapeHtml(prescription.imageUrl)}" alt="${escapeHtml(prescription.prescriptionName)}" class="db-card-image">` : ''}
                        <div class="db-card-header">
                            ${escapeHtml(prescription.prescriptionName)}
                        </div>
                        <div class="db-card-body">
                            <div class="db-card-field">
                                <div class="db-card-label">ID</div>
                                <div class="db-card-value">${prescription.prescriptionId}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">成分</div>
                                <div class="db-card-value multiline">${escapeHtml(prescription.composition)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">成分用量</div>
                                <div class="db-card-value">${escapeHtml(prescription.dosage)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">用途</div>
                                <div class="db-card-value">${escapeHtml(prescription.treatment)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">药方来源</div>
                                <div class="db-card-value">${escapeHtml(prescription.source)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">适用人群</div>
                                <div class="db-card-value">${escapeHtml(prescription.suitablePopulation)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">注意事项</div>
                                <div class="db-card-value multiline">${escapeHtml(prescription.precautions)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">分类</div>
                                <div class="db-card-value">${escapeHtml(prescription.category)}</div>
                            </div>
                        </div>
                        <div class="db-card-footer">
                            <button class="btn btn-primary" onclick="viewPrescriptionDetail('${prescription.prescriptionId}')">查看详情</button>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // 加载文献信息数据
        function loadLiteratureData() {
            $("#literature-cards").html('<div class="loader mx-auto"></div>');
            $.ajax({
                type: 'get',
                url: `/db/literatureAll`,
                success: function (response) {
                    console.log(`loadLiteratureData success: records=${response.length}`);
                    const literatures = response;
                    const html = generateLiteratureCards(literatures);
                    $("#literature-cards").html(html || '<div class="text-center p-4">暂无文献数据</div>');
                },
                error: function (xhr, status, error) {
                    console.error("获取文献数据失败:", error);
                    $("#literature-cards").html('<div class="text-center p-4 text-danger">获取数据失败，请稍后再试</div>');
                }
            });
        }

        // 生成文献卡片
        function generateLiteratureCards(literatures) {
            let html = '';
            for (const literature of literatures) {
                html += `
                    <div class="db-card">
                        <div class="db-card-header">
                            ${escapeHtml(literature.title)}
                        </div>
                        <div class="db-card-body">
                            <div class="db-card-field">
                                <div class="db-card-label">ID</div>
                                <div class="db-card-value">${literature.literatureId}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">藏文标题</div>
                                <div class="db-card-value">${escapeHtml(literature.tibetanTitle)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">作者</div>
                                <div class="db-card-value">${escapeHtml(literature.authors)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">出版年份</div>
                                <div class="db-card-value">${literature.publicationYear || '未知'}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">期刊/出版社</div>
                                <div class="db-card-value">${escapeHtml(literature.journalOrPublisher)}</div>
                            </div>
                            <div class="db-card-field">
                                <div class="db-card-label">摘要</div>
                                <div class="db-card-value multiline">${escapeHtml(literature.abstract)}</div>
                            </div>
                        </div>
                        <div class="db-card-footer">
                            <button class="btn btn-primary" onclick="viewLiteratureDetail('${literature.literatureId}')">查看详情</button>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        // 查看药材详情
        function viewHerbDetail(id) {
            $.ajax({
                type: 'get',
                url: `/db/herbDetail`,
                data: { id: id },
                success: function (herb) {
                    let detailHtml = `
                        <div class="detail-content">
                            <p><strong>ID:</strong> ${herb.herbId}</p>
                            <p><strong>药材名称:</strong> ${escapeHtml(herb.herbName)}</p>
                            <p><strong>关联植物ID:</strong> ${herb.plantId || '无'}</p>
                            <p><strong>藏文名:</strong> ${escapeHtml(herb.herbTibetanName)}</p>
                            <p><strong>别名:</strong> ${escapeHtml(herb.herbAlias)}</p>
                            <p><strong>描述:</strong> ${escapeHtml(herb.herbDescription)}</p>
                            <p><strong>药用部位:</strong> ${escapeHtml(herb.partUsed)}</p>
                            <p><strong>特征:</strong> ${escapeHtml(herb.herbFeatures)}</p>
                            <p><strong>性味归经:</strong> ${escapeHtml(herb.flavorTropism)}</p>
                            <p><strong>功能与主治:</strong> ${escapeHtml(herb.functionIndication)}</p>
                            <p><strong>临床应用:</strong> ${escapeHtml(herb.clinicalApplication)}</p>
                            <p><strong>药理作用:</strong> ${escapeHtml(herb.pharmacologicalEffect)}</p>
                            <p><strong>附注:</strong> ${escapeHtml(herb.notes)}</p>
                        </div>
                    `;

                    document.getElementById('detail-modal-title').textContent = '药材详情';
                    document.getElementById('detail-modal-body').innerHTML = detailHtml;
                    openModal('detail-modal');
                },
                error: function (xhr, status, error) {
                    console.error("获取药材详情失败:", error);
                    alert("获取药材详情失败");
                }
            });
        }

        // 查看植物详情
        function viewPlantDetail(id) {
            $.ajax({
                type: 'get',
                url: `/db/plantDetail`,
                data: { id: id },
                success: function (plant) {
                    const imgUrl = "http://175.24.205.213:82/usr/local/nginx/images/plant/" + plant.imgPath;
                    let detailHtml = `
                        <div class="detail-content">
                            ${plant.imgPath ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(plant.plantName)}" class="mb-4 w-full h-auto rounded">` : ''}
                            <p><strong>ID:</strong> ${plant.plantId}</p>
                            <p><strong>植物名称:</strong> ${escapeHtml(plant.plantName)}</p>
                            <p><strong>拉丁学名:</strong> ${escapeHtml(plant.plantLatin)}</p>
                            <p><strong>别称:</strong> ${escapeHtml(plant.plantAlias)}</p>
                            <p><strong>藏文名:</strong> ${escapeHtml(plant.plantTibetanName)}</p>
                            <p><strong>科名:</strong> ${escapeHtml(plant.plantFamilyName)}</p>
                            <p><strong>属名:</strong> ${escapeHtml(plant.plantGenusName)}</p>
                            <p><strong>特征:</strong> ${escapeHtml(plant.plantFeatures)}</p>
                            <p><strong>采集地点:</strong> ${escapeHtml(plant.plantOrigin)}</p>
                            <p><strong>保护等级:</strong> ${escapeHtml(plant.plantProtectLevel)}</p>
                            <p><strong>附注:</strong> ${escapeHtml(plant.notes)}</p>
                        </div>
                    `;

                    document.getElementById('detail-modal-title').textContent = '植物详情';
                    document.getElementById('detail-modal-body').innerHTML = detailHtml;
                    openModal('detail-modal');
                },
                error: function (xhr, status, error) {
                    console.error("获取植物详情失败:", error);
                    alert("获取植物详情失败");
                }
            });
        }

        // 查看药方详情
        function viewPrescriptionDetail(id) {
            $.ajax({
                type: 'get',
                url: `/db/prescriptionDetail`,
                data: { id: id },
                success: function (prescription) {
                    const imgUrl = "http://175.24.205.213:83" + prescription.filePath;
                    let detailHtml = `
                        <div class="detail-content">
                            ${prescription.imageUrl ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(prescription.prescriptionName)}" class="mb-4 w-full h-auto rounded">` : ''}
                            <p><strong>ID:</strong> ${prescription.prescriptionId}</p>
                            <p><strong>药方名称:</strong> ${escapeHtml(prescription.prescriptionName)}</p>
                            <p><strong>成分:</strong> ${escapeHtml(prescription.composition)}</p>
                            <p><strong>成分用量:</strong> ${escapeHtml(prescription.dosage)}</p>
                            <p><strong>用途:</strong> ${escapeHtml(prescription.treatment)}</p>
                            <p><strong>药方来源:</strong> ${escapeHtml(prescription.source)}</p>
                            <p><strong>适用人群:</strong> ${escapeHtml(prescription.suitablePopulation)}</p>
                            <p><strong>注意事项:</strong> ${escapeHtml(prescription.precautions)}</p>
                            <p><strong>分类:</strong> ${escapeHtml(prescription.category)}</p>
                            <p><strong>制备方法:</strong> ${escapeHtml(prescription.preparationMethod)}</p>
                            <p><strong>推荐医生/专家:</strong> ${escapeHtml(prescription.doctorOrExpert)}</p>
                            <p><strong>状态:</strong> ${escapeHtml(prescription.status)}</p>
                            <p><strong>用户评分:</strong> ${prescription.rating}</p>
                            <p><strong>评价总数:</strong> ${prescription.reviewsCount}</p>
                            <p><strong>版本号:</strong> ${escapeHtml(prescription.version)}</p>
                            <p><strong>药材ID列表:</strong> ${escapeHtml(prescription.medicineIds)}</p>
                            <p><strong>是否公开:</strong> ${prescription.is_public ? '是' : '否'}</p>
                            <p><strong>创建时间:</strong> ${new Date(prescription.createTime).toLocaleString()}</p>
                            <p><strong>更新时间:</strong> ${new Date(prescription.updateTime).toLocaleString()}</p>
                        </div>
                    `;

                    document.getElementById('detail-modal-title').textContent = '药方详情';
                    document.getElementById('detail-modal-body').innerHTML = detailHtml;
                    openModal('detail-modal');
                },
                error: function (xhr, status, error) {
                    console.error("获取药方详情失败:", error);
                    alert("获取药方详情失败");
                }
            });
        }

        // 查看文献详情
        function viewLiteratureDetail(id) {
            $.ajax({
                type: 'get',
                url: `/db/literatureDetail`,
                data: { id: id },
                success: function (literature) {
                    let detailHtml = `
                        <div class="detail-content">
                            <p><strong>ID:</strong> ${literature.literatureId}</p>
                            <p><strong>文献标题:</strong> ${escapeHtml(literature.title)}</p>
                            <p><strong>藏文标题:</strong> ${escapeHtml(literature.tibetanTitle)}</p>
                            <p><strong>作者:</strong> ${escapeHtml(literature.authors)}</p>
                            <p><strong>出版年份:</strong> ${literature.publicationYear || '未知'}</p>
                            <p><strong>期刊/出版社:</strong> ${escapeHtml(literature.journalOrPublisher)}</p>
                            <p><strong>卷期:</strong> ${escapeHtml(literature.volumeIssue)}</p>
                            <p><strong>页码:</strong> ${escapeHtml(literature.pages)}</p>
                            <p><strong>摘要:</strong> ${escapeHtml(literature.abstract)}</p>
                            <p><strong>下载链接:</strong> ${literature.downloadLink ? `<a href="${escapeHtml(literature.downloadLink)}" target="_blank">下载</a>` : '无'}</p>
                            <p><strong>文件路径:</strong> ${literature.filePath ? `<a href="${escapeHtml(literature.filePath)}" target="_blank">查看文件</a>` : '无'}</p>
                            <p><strong>主要植物:</strong> ${escapeHtml(literature.mainPlant)}</p>
                            <p><strong>研究领域:</strong> ${escapeHtml(literature.researchField)}</p>
                            <p><strong>关键词:</strong> ${escapeHtml(literature.keywords)}</p>
                            <p><strong>创建时间:</strong> ${new Date(literature.createTime).toLocaleString()}</p>
                            <p><strong>更新时间:</strong> ${new Date(literature.updateTime).toLocaleString()}</p>
                        </div>
                    `;

                    document.getElementById('detail-modal-title').textContent = '文献详情';
                    document.getElementById('detail-modal-body').innerHTML = detailHtml;
                    openModal('detail-modal');
                },
                error: function (xhr, status, error) {
                    console.error("获取文献详情失败:", error);
                    alert("获取文献详情失败");
                }
            });
        }

        // 打开模态框
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
        }

        // 防止 XSS 攻击的转义函数
        function escapeHtml(str) {
            if (!str) return '';
            return str.toString().replace(/[&<>"']/g, function (match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        // 页面加载时默认显示药材信息表
        window.onload = () => {
            switchTab('herb');
        };
    </script>
</body>

</html>